<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sahayata â€¢ Wellness Journeys</title>
  <link href="../assets/css/style.css" rel="stylesheet" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="../index.html"><span class="brand-mark">âœ¦</span><span class="brand-text">Sahayata</span></a>
      <nav class="primary-nav" aria-label="Primary">
        <a href="./guide.html" title="Personal Guide">Personal Guide</a>
        <a href="./samvad.html" title="Anonymous community">Samvad</a>
        <a href="./abhyas.html" title="Resilience toolkit">Abhyas</a>
        <a href="./journeys.html" aria-current="page" title="Wellness journeys">Journeys</a>
        <a href="./professionals.html" title="Therapists">Professional Connect</a>
        <a href="./section-5.html" title="Why Sahayata works">Why us</a>
        <div class="user-menu">
          <span class="user-name"></span>
          <a href="#" class="logout-btn">Sign Out</a>
        </div>
        <a class="btn btn-ghost" href="./auth.html" id="auth-link">Sign In</a>
        <a class="nav-cta" href="tel:18005990019" aria-label="Aapatkal â€“ Call Tele MANAS 24 by 7">Aapatkal</a>
      </nav>
    </div>
  </header>
  <main class="container">
    <section class="hero">
      <h1>Wellness Journeys</h1>
  <p class="lead">Start with a few simple defaults or create your own. Only you can see your progress.</p>
      <div class="actions">
  <button class="btn btn-primary" onclick="handleCreateJourney()" data-auth-required="create a journey">Create Custom Journey</button>
      </div>
    </section>
    
    <section class="narrow">
      <div class="hero-card">
        <h3>Your Progress</h3>
        <ul class="stat-list">
          <li><span class="stat" id="total-points">0</span><span class="label">points earned</span></li>
          <li><span class="stat" id="active-journeys">0</span><span class="label">active journeys</span></li>
          <li><span class="stat" id="completed-steps">0</span><span class="label">steps completed</span></li>
        </ul>
      </div>
    </section>

    <!-- Custom Journey Creation Form -->
    <section id="create-form" class="narrow" style="display: none;">
      <div class="card">
        <h2>Create Custom Journey</h2>
        <form id="journey-form">
          <div class="form-group">
            <label for="journey-title">Journey Title</label>
            <input type="text" id="journey-title" placeholder="e.g., My Exam Stress Relief Journey" required>
          </div>
          <div class="form-group">
            <label for="journey-description">Description</label>
            <textarea id="journey-description" placeholder="What will this journey help you achieve?" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="journey-duration">Duration (days)</label>
            <select id="journey-duration">
              <option value="7">7 days</option>
              <option value="14">14 days</option>
              <option value="21">21 days</option>
              <option value="30" selected>30 days</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="form-group" id="custom-duration" style="display: none;">
            <label for="custom-days">Custom Duration (days)</label>
            <input type="number" id="custom-days" min="1" max="365" placeholder="Enter number of days">
          </div>
          <div class="form-group">
            <label for="journey-category">Category</label>
            <select id="journey-category">
              <option value="stress-management">Stress Management</option>
              <option value="exam-prep">Exam Preparation</option>
              <option value="sleep-hygiene">Sleep Hygiene</option>
              <option value="mindfulness">Mindfulness & Meditation</option>
              <option value="social-skills">Social Skills</option>
              <option value="productivity">Productivity</option>
              <option value="self-care">Self-Care</option>
              <option value="physical-wellness">Physical Wellness</option>
              <option value="emotional-regulation">Emotional Regulation</option>
              <option value="confidence">Confidence Building</option>
            </select>
          </div>
          <div class="form-group">
            <label>Daily Activities (one per line)</label>
            <textarea id="journey-activities" placeholder="Enter activities, one per line:
Practice 5 minutes of deep breathing
Write down 3 things you're grateful for
Take a 10-minute walk
Listen to calming music for 15 minutes" rows="8"></textarea>
            <small style="color: var(--muted);">Each line will become a daily step in your journey</small>
          </div>
          <div class="actions">
            <button type="submit" class="btn btn-primary" data-auth-required="create a journey">Create Journey</button>
            <button type="button" class="btn btn-ghost" onclick="hideCreateForm()">Cancel</button>
          </div>
        </form>
      </div>
    </section>
    
    <section>
      <div id="list" class="grid"></div>
    </section>
    
    <section class="narrow about">
      <h2>How journeys work</h2>
      <p>Each journey is designed around evidence-based practices broken into small, manageable daily steps. Complete steps to earn points and build lasting habits. The gentle gamification makes self-care feel rewarding rather than overwhelming.</p>
      
      <h3>Journey Categories</h3>
      <div class="category-grid">
        <div class="category-card">
          <h4>ðŸ§˜ Mindfulness</h4>
          <p>Build awareness, reduce anxiety, and improve focus through meditation and breathing exercises.</p>
        </div>
        <div class="category-card">
          <h4>ðŸ“š Exam Prep</h4>
          <p>Develop healthy study habits, manage exam stress, and build confidence for academic success.</p>
        </div>
        <div class="category-card">
          <h4>ðŸ’ª Stress Management</h4>
          <p>Learn techniques to cope with pressure, build resilience, and maintain emotional balance.</p>
        </div>
        <div class="category-card">
          <h4>ðŸ˜´ Sleep Hygiene</h4>
          <p>Establish healthy sleep patterns for better rest, improved mood, and enhanced cognitive function.</p>
        </div>
      </div>
    </section>
  </main>
  <footer class="site-footer"><div class="container footer-inner"><p>Â© <span id="year"></span> Sahayata</p></div></footer>
  
  <!-- Script dependencies -->
  <script src="../assets/js/particles.js"></script>
  <script src="../assets/js/main.js"></script>
  <script src="../assets/js/auth.js"></script>
  
  <script type="module">
  import { api, getUserId } from '../assets/js/app.js';
    
    // Handle journey creation with auth check
    window.handleCreateJourney = function() {
      // Check if user is authenticated
      if (window.sahayataAuth && !window.sahayataAuth.isLoggedIn) {
        window.sahayataAuth.requireAuth('create a journey');
        return;
      }
      // If authenticated, show the create form
      showCreateForm();
    };
    
    const root = document.getElementById('list');
    const totalPoints = document.getElementById('total-points');
    const activeJourneys = document.getElementById('active-journeys');
    const completedSteps = document.getElementById('completed-steps');
  let userProgress = {};
  let allJourneys = [];
    
  // Removed default/example journeys: each user manages their own.
    
    // Form handling functions
    window.showCreateForm = function() {
      document.getElementById('create-form').style.display = 'block';
      document.getElementById('create-form').scrollIntoView({ behavior: 'smooth' });
    };
    
    window.hideCreateForm = function() {
      document.getElementById('create-form').style.display = 'none';
      document.getElementById('journey-form').reset();
    };
    
  // Removed: loadDefaultJourneys() â€” no global examples.
    
    // Notification system
    function showNotification(message, type = 'info') {
      // Remove existing notifications
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();
      
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
      `;
      notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" aria-label="Close">&times;</button>
      `;
      
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      // Auto-remove with longer time for success messages
      const autoRemoveTime = type === 'success' ? 6000 : 5000;
      setTimeout(() => {
        if (notification.parentElement) {
          notification.style.opacity = '0';
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => notification.remove(), 300);
        }
      }, autoRemoveTime);
    }
    
    // Duration selector handling
    document.getElementById('journey-duration').addEventListener('change', function() {
      const customDiv = document.getElementById('custom-duration');
      if (this.value === 'custom') {
        customDiv.style.display = 'block';
      } else {
        customDiv.style.display = 'none';
      }
    });
    
    // Form submission
    document.getElementById('journey-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Check authentication before creating journey
      if (window.sahayataAuth && !window.sahayataAuth.isLoggedIn) {
        window.sahayataAuth.requireAuth('create a journey');
        return;
      }
      
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      
      // Disable form during submission
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';
      
      try {
        const title = document.getElementById('journey-title').value.trim();
        const description = document.getElementById('journey-description').value.trim();
        const duration = document.getElementById('journey-duration').value;
        const customDays = document.getElementById('custom-days').value;
        const category = document.getElementById('journey-category').value;
        const activitiesText = document.getElementById('journey-activities').value.trim();
        
        // Validation
        if (!title) {
          throw new Error('Please enter a journey title');
        }
        
        if (title.length > 100) {
          throw new Error('Title must be 100 characters or less');
        }
        
        if (description.length > 500) {
          throw new Error('Description must be 500 characters or less');
        }
        
        const steps = duration === 'custom' ? parseInt(customDays) : parseInt(duration);
        
        if (duration === 'custom' && (!customDays || steps < 1 || steps > 365)) {
          throw new Error('Custom duration must be between 1 and 365 days');
        }
        
        if (!activitiesText) {
          throw new Error('Please add at least one activity');
        }
        
        const activities = activitiesText.split('\n').filter(a => a.trim()).map(a => a.trim());
        
        if (activities.length === 0) {
          throw new Error('Please add at least one valid activity');
        }
        
        // Check for activity length
        for (let activity of activities) {
          if (activity.length > 200) {
            throw new Error('Each activity must be 200 characters or less');
          }
        }
        
        // If fewer activities than days, cycle through them
        const finalActivities = [];
        for (let i = 0; i < steps; i++) {
          finalActivities.push(activities[i % activities.length]);
        }
        
        const journey = {
          title,
          description,
          activities: finalActivities,
          category
        };
        
        const userId = getUserId();
        if (!userId) {
          showNotification('Please sign in to create a journey', 'error');
          return;
        }
        await api.post('/api/journeys', { 
          userId, 
          action: 'create',
          ...journey 
        });
        
        hideCreateForm();
        showNotification('Custom journey created successfully! ðŸŽ‰', 'success');
        setTimeout(() => load(), 1500); // Wait for notification then reload
        
      } catch (error) {
        console.error('Journey creation error:', error);
        let errorMessage = error.message;
        
        // Handle specific API errors
        if (error.message.includes('429')) {
          errorMessage = 'You\'re creating journeys too quickly. Please wait before creating another one.';
        } else if (error.message.includes('409')) {
          errorMessage = 'You already have a journey with this title. Please choose a different name.';
        } else if (error.message.includes('400')) {
          errorMessage = 'Please check your input and try again.';
        } else if (!errorMessage || errorMessage === 'Failed to fetch') {
          errorMessage = 'Failed to create journey. Please check your connection and try again.';
        }
        
        showNotification(errorMessage, 'error');
      } finally {
        // Re-enable form
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
    
  async function load(){
      try {
        let userId = '';
        
        // Wait for auth to be initialized
        let attempts = 0;
        while (attempts < 10 && (!window.sahayataAuth || window.sahayataAuth.isLoggedIn === undefined)) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }
        
        // Check if user is authenticated and get their ID
        const userIdFromAuth = getUserId();
        const isAuthenticated = !!(window.sahayataAuth && window.sahayataAuth.isLoggedIn && userIdFromAuth);
        
        if (isAuthenticated) {
          userId = userIdFromAuth;
        }
        
        const res = await api.get(`/api/journeys?userId=${encodeURIComponent(userId || '')}`);
        allJourneys = Array.isArray(res.journeys) ? res.journeys : [];
        userProgress = res.progress || {};
        
      } catch (error) {
        console.error('Error loading journeys:', error);
        allJourneys = [];
        userProgress = {};
      }
      
      render();
    }
    
    function render() {
      // Calculate user stats
      let totalPts = 0, activeCount = 0, stepsCount = 0;
      allJourneys.forEach(j => {
  const progress = userProgress[j.key] || 0;
        if(progress > 0){
          totalPts += Math.min(progress, j.steps) * (j.points / j.steps);
          if(progress < j.steps) activeCount++;
          stepsCount += Math.min(progress, j.steps);
        }
      });
      
      totalPoints.textContent = Math.round(totalPts);
      activeJourneys.textContent = activeCount;
      completedSteps.textContent = stepsCount;
      
      if (allJourneys.length === 0) {
        root.innerHTML = `
          <div class="card">
            <h3>No journeys yet</h3>
            <p class="lead" style="color:var(--muted)">Create your first journey to start tracking simple daily steps that help.</p>
            <div class="actions"><button class="btn btn-primary" onclick="showCreateForm()">Create a journey</button></div>
          </div>
        `;
        totalPoints.textContent = '0';
        activeJourneys.textContent = '0';
        completedSteps.textContent = '0';
        return;
    }

    const canManage = !!(window.sahayataAuth && window.sahayataAuth.isLoggedIn);

  root.innerHTML = allJourneys.map(j => {
        const progress = userProgress[j.key] || 0;
        const progressPercent = Math.round((progress / j.steps) * 100);
        const pointsEarned = Math.round((progress / j.steps) * j.points);
        const currentActivity = j.activities ? j.activities[progress] || 'Journey completed!' : 'Continue your journey';
        
        return `<div class="card journey-card">
          <div class="journey-header">
            <h3>${j.title}</h3>
    ${j.isCustom ? '<span class="custom-badge">Custom</span>' : (j.isCore ? '<span class="category-badge">Core</span>' : '')}
            <span class="category-badge">${j.category || 'general'}</span>
          </div>
          <p>${j.description || ''}</p>
          <div class="current-activity">
            <strong>Today's activity:</strong>
            <p>${currentActivity}</p>
          </div>
          <div style="margin:12px 0">
            <div style="background:var(--ring); height:8px; border-radius:4px; overflow:hidden">
              <div style="background:var(--brand-2); height:100%; width:${progressPercent}%; transition:width 0.3s"></div>
            </div>
            <small style="color:var(--muted)">${progress}/${j.steps} steps â€¢ ${pointsEarned}/${j.points} points</small>
          </div>
          <div class="journey-actions">
            <button class="btn btn-primary" data-key="${j.key}" ${progress >= j.steps ? 'disabled' : ''}>
              ${progress >= j.steps ? 'Completed âœ“' : 'Complete Today\'s Step'}
            </button>
  ${canManage ? `<button class="btn btn-ghost btn-sm" onclick="deleteJourney('${j.key}')">Delete</button>` : ''}
          </div>
        </div>`;
      }).join('');
      
  root.querySelectorAll('button[data-key]').forEach(btn=>btn.addEventListener('click', async ()=>{
        const key = btn.dataset.key;
        const userId = getUserId();
        if (!userId) {
          showNotification('Please sign in to track progress', 'error');
          return;
        }
        await api.post('/api/journeys', { userId, journeyKey: key, action: 'progress' });
        
        // Update local progress
        userProgress[key] = (userProgress[key] || 0) + 1;
        
        btn.textContent = 'Great job! âœ“';
        showNotification('Step completed! Keep going! ðŸŒŸ', 'success');
        setTimeout(() => load(), 2000); // Show success message longer
      }));
    }
    
    window.deleteJourney = async function(key) {
      const journey = allJourneys.find(j => j.key === key);
      const journeyType = journey && journey.isCore ? 'core journey' : 'custom journey';
      const actionText = journey && journey.isCore ? 'remove' : 'delete';
      
      if (confirm(`${actionText} this ${journeyType}? This will ${journey && journey.isCore ? 'remove it from your view and clear' : 'delete it and clear'} your progress.`)) {
        try {
          const userId = getUserId();
          if (!userId) {
            showNotification('Please sign in to manage journeys', 'error');
            window.sahayataAuth && window.sahayataAuth.requireAuth('manage journeys');
            return;
          }
          
          // Immediately remove from local list for better UX
          allJourneys = allJourneys.filter(j => j.key !== key);
          
          // Reset progress locally
          userProgress[key] = 0;
          
          // Re-render immediately
          render();
          
          const result = await api.post('/api/journeys', { userId, journeyKey: key, action: 'delete' });
          
          const message = result.isCore ? 'Core journey removed from your view' : 'Custom journey deleted successfully';
          showNotification(message, 'success');
          
          // Reload after a shorter delay to sync with server
          setTimeout(() => load(), 800);
        } catch (error) {
          console.error('Delete error:', error);
          showNotification('Error managing journey: ' + error.message, 'error');
          // Reload to restore correct state if operation failed
          setTimeout(() => load(), 500);
        }
      }
    };
    
    // Initialize when page loads and auth is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Wait a bit for auth to initialize, then load
      setTimeout(() => {
        load();
      }, 200);
    });
    
    // Also load when auth state changes
    window.addEventListener('authStateChanged', function() {
      setTimeout(() => {
        load();
      }, 100);
    });
  </script>
</body>
</html>
